<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Tugas Besar UTS IN253 Grafika Komputer</title>
		<link rel="stylesheet" href="css/style.css" />
		<script type="module" src="js/grafika_lib.js"></script>
	</head>
	<body>
		<h1>Tugas Besar UTS IN253 Grafika Komputer</h1>
		<canvas id="canvas1" width="600" height="600"></canvas>
		<div class="buttons">
			<button id="tombolEdit">Mode Ubah Node (Mati)</button>
			<button id="tombolPath">Mode Buat Path (Mati)</button>
			<button id="tombolMove">Mode Pindah Node (Mati)</button>
		</div>
		
		<script type="module">
			import { dda_line, drawSquare } from "./js/grafika_lib.js";
			
			const canvas = document.getElementById("canvas1");
			const context = canvas.getContext("2d");
			const boxSize = 20;
			const points = []; //konstanta untuk menyimpan semua titik node
			const paths = []; //konstanta untuk menyimpan semua garis
	  
			const tombolEdit = document.getElementById("tombolEdit");
			const tombolPath = document.getElementById("tombolPath");
			const tombolMove = document.getElementById("tombolMove");

			let editMode = false;
			let pathMode = false;
			let moveMode = false;
	  
			let draggingNode = null;
			let offsetX = 0;
			let offsetY = 0;

			let startNode = null;
			let endNode = null;
	  
			// Fungsi menggambar ulang semua elemen di canvas
			function redrawCanvas() {
				context.clearRect(0, 0, canvas.width, canvas.height); //membersihkan canvas
				let img = context.getImageData(0, 0, canvas.width, canvas.height);
				
				// Gambar path
				for (const path of paths) {
					dda_line(img, path.start.x, path.start.y, path.end.x, path.end.y, 0, 0, 0, canvas);
				}
				// Gambar Path

				// Gambar garis antar node ketika ada node baru
				if (points.length > 1) {
					for (let i = 0; i < points.length - 1; i++) {
						dda_line(img, points[i].x, points[i].y, points[i + 1].x, points[i + 1].y, 100, 100, 100, canvas);
					}
				}
				// Gambar garis antar node ketika ada node baru
				
				// Gambar kotak di setiap node
				for (const p of points) {
					let color = [0, 255, 0];
					if (startNode && p === startNode) color = [0, 0, 255];
					else if (endNode && p === endNode) color = [255, 0, 0];
					drawSquare(img, p.x, p.y, boxSize, color[0], color[1], color[2], canvas);
				}
				// Gambar kotak di setiap node

				// hasil ke canvas
				context.putImageData(img, 0, 0);
				// hasil ke canvas
	  
				// text angka di dalam node
				for (const p of points) {
					context.fillStyle = "black";
					context.strokeStyle = "black";
					context.font = "12px Arial";
					context.textAlign = "center";
					context.textBaseline = "middle";
					context.strokeText(p.label, p.x, p.y);
					context.fillText(p.label, p.x, p.y);
				}
				// text angka di dalam node
			};
			// Fungsi menggambar ulang semua elemen di canvas
	  
			// Fungsi menambah node baru
			function drawBox(x, y) {
				points.push({ x, y, label: points.length + 1 });
				redrawCanvas();
			}
			// Fungi menambah node baru
	  
			// Fungsi return node yang di klik
			function findNode(x, y) {
				const half = boxSize / 2;
				return points.find(p => x >= p.x - half && x <= p.x + half && y >= p.y - half && y <= p.y + half);
			}
			// Fungsi return node yang di klik
	  
			// Tombol Edit Mode
			tombolEdit.addEventListener("click", () => {
				editMode = !editMode;
				pathMode = moveMode = false;
				resetButtons();
				if (editMode) {
					tombolEdit.textContent = "Mode Ubah Node (Aktif)";
					tombolEdit.style.backgroundColor = "lightgreen";
					canvas.style.cursor = "default";
				} else {
					tombolEdit.textContent = "Mode Ubah Node (Mati)";
					canvas.style.cursor = "crosshair";
				}
			});
			// Tombol Edit Mode
	  
			// Tombol Path Mode
			tombolPath.addEventListener("click", () => {
				pathMode = !pathMode;
				editMode = moveMode = false;
				resetButtons();
				if (pathMode) {
					tombolPath.textContent = "Mode Buat Path (Aktif)";
					tombolPath.style.backgroundColor = "lightblue";
					canvas.style.cursor = "pointer";
				} else {
					tombolPath.textContent = "Mode Buat Path (Mati)";
					canvas.style.cursor = "crosshair";
				}
			});
			// Tombol Path Mode

			// Tombol Move Node
			tombolMove.addEventListener("click", () => {
				moveMode = !moveMode;
				editMode = pathMode = false;
				resetButtons();
				if (moveMode) {
					tombolMove.textContent = "Mode Pindah Node (Aktif)";
					tombolMove.style.backgroundColor = "khaki";
					canvas.style.cursor = "move";
				} else {
					tombolMove.textContent = "Mode Pindah Node (Mati)";
					canvas.style.cursor = "crosshair";
				}
			});
			//Tombol Move Node

			//Reset semua button
			function resetButtons() {
				tombolEdit.textContent = "Mode Ubah Node (Mati)";
				tombolEdit.style.backgroundColor = "";
				tombolPath.textContent = "Mode Buat Path (Mati)";
				tombolPath.style.backgroundColor = "";
				tombolMove.textContent = "Mode Pindah Node (Mati)";
				tombolMove.style.backgroundColor = "";
			}
			//Reset semua button
			
			// Set Dragging
			canvas.addEventListener("mousedown", (e) => {
				if (!moveMode) return;
				const rect = canvas.getBoundingClientRect();
				const x = e.clientX - rect.left;
				const y = e.clientY - rect.top;
				const node = findNode(x, y); //panggil fungsi findNode untuk menentukan node yang diklik
				if (node) {
					draggingNode = node;
					offsetX = x - node.x;
					offsetY = y - node.y;
				}
			});
			// Set Dragging

			// Dragging Node
			canvas.addEventListener("mousemove", (e) => {
				if (moveMode && draggingNode) {
					const rect = canvas.getBoundingClientRect();
					const x = e.clientX - rect.left - offsetX;
					const y = e.clientY - rect.top - offsetY;
					draggingNode.x = x;
					draggingNode.y = y;
					redrawCanvas();
				}
			});
			// Dragging Node

			// Matikan Dragging
			canvas.addEventListener("mouseup", () => {
				if (moveMode) draggingNode = null;
			});
			// Matikan Dragging

			// Event Klik pada canvas
			canvas.addEventListener("click", (event) => {
			  const rect = canvas.getBoundingClientRect();
			  const x = event.clientX - rect.left;
			  const y = event.clientY - rect.top;
			  const clickedNode = findNode(x, y);
	  
			  // mode edit node untuk mengubah label node
			  if (editMode) {
				if (clickedNode) {
				  const newLabel = prompt(
					"Masukkan label baru untuk node:",
					clickedNode.label
				  );
				  if (newLabel !== null && newLabel.trim() !== "") {
					clickedNode.label = newLabel;
				  }
				}
			  }
			  // mode edit node untuk mengubah label node 

			  // mode pathNode untuk menambah garis antara node 
			  else if (pathMode) {
				if (clickedNode) {
				  if (!startNode) {
					startNode = clickedNode;
					endNode = null;
				  } else {
					endNode = clickedNode;
					if (startNode !== endNode) {
					  paths.push({ start: startNode, end: endNode });
					}
					startNode = null;
					endNode = null;
				  }
				}
			  }
			  // mode pathNode untuk menambah garis antara node 
			  else if (!moveMode && !clickedNode) {
					drawBox(x, y);
				}
			  redrawCanvas();
			});
		  </script>		
	</body>
</html>
