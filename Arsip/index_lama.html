<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Tugas Besar UTS IN253 Grafika Komputer</title>
		<link rel="stylesheet" href="css/style.css" />
		<script type="module" src="js/grafika_lib.js"></script>
		<script src="js/transform.js"></script>
		<script src="js/transformasi_matriks.js"></script>
	</head>
	<body>
		<h1>Tugas Besar UTS IN253 Grafika Komputer</h1>
		<canvas id="canvas1" width="600" height="600"></canvas>
		<button id="tombolEdit">Mode Ubah Node (Mati)</button>
		<button id="tombolPath">Mode Buat Path (Mati)</button>
		<script>
			// Inisiasi canvas
			const canvas = document.getElementById("canvas1");
			const context = canvas.getContext("2d");
			const boxSize = 20;
			const points = [];
			const paths = [];
			// Inisiasi canvas

			const tombolEdit = document.getElementById("tombolEdit");
			const tombolPath = document.getElementById("tombolPath");
			let editMode = false;
			let pathMode = false;

			let startNode = null;
			let endNode = null;
			
			// Fungsi Polygon
			function polygon(context, points, fill = false, stroke = true) {
				if (points.length < 2) return;
				context.beginPath();
				context.moveTo(points[0].x, points[0].y);
				for (let i = 1; i < points.length; i++) {
					context.lineTo(points[i].x, points[i].y);
				}
				context.closePath();
				if (fill) context.fill();
				if (stroke) context.stroke();
			}
			// Fungsi Polygon

			// Fungsi Polyline
			function polyline(context, points, stroke = true) {
				if (points.length < 2) return;
				context.beginPath();
				context.moveTo(points[0].x, points[0].y);
				for (let i = 1; i < points.length; i++) {
					context.lineTo(points[i].x, points[i].y);
				}
				if (stroke) context.stroke();
			}
			// Fungsi Polyline

			// Fungsi gambar kotak
			function drawBox(x, y) {
				context.fillStyle = "green";
				context.fillRect(x - boxSize / 2, y - boxSize / 2, boxSize, boxSize);
			
				// Gambar node
				const label = points.length + 1;
				points.push({ x, y, label });
			
				// Gambar angka
				context.fillStyle = "white";
				context.font = "12px Arial";
				context.textAlign = "center";
				context.textBaseline = "middle";
				context.fillText(label, x, y);

			}
			// Fungsi gambar kotak

			
			//fungsi menggambar ulang canvas
			function redrawCanvas() {
				context.clearRect(0, 0, canvas.width, canvas.height);

				// Gambar semua kotak dan label
				points.forEach((point) => {
					context.fillStyle = "green";
					context.fillRect(
						point.x - boxSize / 2,
						point.y - boxSize / 2,
						boxSize,
						boxSize
					);
			
					const textMargin = 4; 
                	context.font = "12px Arial";
                	context.textAlign = "center";
					const pengukuranTeks = context.measureText(point.label);
					const lebarTeks = pengukuranTeks.width;
                	const padding = 4; 

					if (lebarTeks < boxSize - padding) {
                    // jika text muat didalam node kotak, buat textnya didalam kotak 
	                    context.fillStyle = "white"; 
	                    context.textBaseline = "middle"; 
	                    context.fillText(point.label, point.x, point.y);
               		} else {
                    //  jika text tidak muat didalam node kotak, buat textnya diluar node  atau kotak 
	                    context.fillStyle = "black"; 
	                    context.textBaseline = "top"; 
	                    const yPos = point.y + (boxSize / 2) + textMargin;
	                    context.fillText(point.label, point.x, yPos);
                	}
            	});
        
		
				// Gambar garis antar node
				if (points.length >= 2) {
					context.strokeStyle = "black";
					context.lineWidth = 2;
					polyline(context, points);
				}
			}

			//fungsi mengecek  klik mengenai node (kotak) atau tidak
			function findNode(x, y) {
            const jaraktepi = boxSize / 2;
            for (let i = points.length - 1; i >= 0; i--) { 
                const point = points[i];
                if (x >= point.x - jaraktepi && x <= point.x +jaraktepi && y >= point.y - jaraktepi && y <= point.y + jaraktepi) {
                    return point; 
                }
            }
        }
			// Script untuk Event tomboledit 
        	tombolEdit.addEventListener("click", () => {
            editMode = !editMode; 
            if (editMode) {
                tombolEdit.textContent = "Mode Ubah Node (Aktif)";
                tombolEdit.style.backgroundColor = "lightgreen";
                canvas.style.cursor = "default"; 
            } else {
                tombolEdit.textContent = "Mode Ubah Node (Mati)";
                tombolEdit.style.backgroundColor = "";
                canvas.style.cursor = "crosshair"; 
            }
        });

		//Event untuk membuat path antara node
		tombolPath.addEventListener("click", () => {
			pathMode = !pathMode;
			if (pathMode) {
				editMode = false;
				tombolEdit.textContent = "Mode Ubah Node (Mati)";
				tombolEdit.style.backgroundColor = "";
				tombolPath.textContent = "Mode Buat Path (Aktif)";
				tombolPath.style.backgroundColor = "lightblue";
				canvas.style.cursor = "pointer";
				startNode = null;
			} else {
				tombolPath.textContent = "Mode Buat Path (Mati)";
				tombolPath.style.backgroundColor = "";
				canvas.style.cursor = "crosshair";
				startNode = null;
			}
		});

			// Script untuk Event
			canvas.addEventListener("click", (event) => {
			const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const clickedNode = findNode(x, y); 
            if (editMode) {
                // jika mode ubah aktif
                if (clickedNode) {
                    // jika klik node maka minta nama baru
                    const newLabel = prompt("Masukkan label baru untuk node:", clickedNode.label);
                    if (newLabel !== null && newLabel.trim() !== "") {
                        clickedNode.label = newLabel;
                    }
                }
            } else if (!editMode) {
                // jika mode ubah mati
                if (!clickedNode) {
                    // buat node baru
                    drawBox(x, y); 
                }
            }
			else if (pathMode) {
				if (clickedNode) {
					if (!startNode) {
						startNode = clickedNode;
						alert(`Start node dipilih: ${clickedNode.label}`);
					} else {
						const endNode = clickedNode;
						if (startNode !== endNode) {
							paths.push({ start: startNode, end: endNode });
							alert(`Path dibuat dari ${startNode.label} ke ${endNode.label}`);
						}
						startNode = null;
					}
				}
			}
			// Mode Tambah Node
			else {
				if (!clickedNode) {
					drawBox(x, y);
				}
			}
            redrawCanvas(); // gambar ulang seluruh canvas
        });
        
		</script>
	</body>
</html>
